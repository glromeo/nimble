<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>parseHTML spec</title>
</head>
<body>
<div id="root"></div>
<script src="../../node_modules/chai/chai.js"></script>
<script src="../../node_modules/mocha/mocha.js"></script>
<script type="module">
    import {
        parseHTML,
        HOLE,
        CHILD_NODE,
        HOOK_ATTR,
        HOOK_NODE,
        PARENT_NODE,
        HOOK_VALUE,
        HOOK_QUOTE,
        HOOK_COMMENT
    } from './parseHTML.mjs'
    import {WebConsole} from '../test/web-console.mjs'

    mocha.setup('tdd')
    mocha.checkLeaks()
    mocha.reporter(WebConsole)

    const {expect} = chai

    function snapshot(root) {
        let text = ''
        for (const node of root.childNodes) {
            if (node.tagName) {
                text += `<${node.tagName}`
                if (node.attributes) for (const {name, value} of node.attributes) {
                    text += ` [${name}]=[${value}]`
                }
                if (node.childNodes.length) {
                    text += '>'
                    text += snapshot(node)
                    text += `</${node.tagName}>`
                } else {
                    text += '/>'
                }
            } else if (node.nodeType === 8) {
                text += `{${node.data}}`
            } else {
                text += `[${node.data}]`
            }
        }
        return text
    }

    function dom(strings) {
        const text = strings.join(HOLE)
        const hasChild = text.endsWith(' \x01')
        switch (text[0]) {
            case '#':
                let data = text.slice(1)
                if (hasChild) {
                    data += arguments[arguments.length - 1]
                }
                return document.createTextNode(data)
            case '@':
                const fragment = document.createDocumentFragment()
                for (let i = 1; i < arguments.length; i++) {
                    fragment.appendChild(arguments[i])
                }
                return fragment
            default:
                const parts = (hasChild ? text.slice(0, -2) : text).split(' ')
                const el = document.createElement(parts[0])
                for (let i = 1, argIndex = 0; i < parts.length; i++) {
                    const [attrName, attrValue] = parts[i].split('=')
                    el.setAttribute(attrName, attrValue === HOLE ? arguments[++argIndex] : attrValue)
                }
                if (hasChild) {
                    const child = arguments[arguments.length - 1]
                    if (typeof child === 'string') {
                        el.innerHTML = child
                    } else {
                        el.appendChild(child)
                    }
                }
                return el
        }
    }

    suite('text nodes', () => {

        const testCase = (id, input, expected, HOOKS) => {
            test(`#${id}: '${input}'`, () => {
                try {
                    const [fragment, ...hooks] = parseHTML(input)
                    const actual = snapshot(dom`div ${fragment}`)
                    expect(actual).to.eq(expected)
                    expect(JSON.stringify(hooks)).to.eq(JSON.stringify(HOOKS))
                } catch (error) {
                    if (expected instanceof Error) {
                        expect(error.message).to.eq(expected.message)
                    } else {
                        throw error
                    }
                }
            })
        }

        const SAME = null

        testCase('00', '', '', [])
        testCase('01', ' ', '[ ]', [])
        testCase('02', ' <', '[ <]', [])
        testCase('03', ' < ', '[ < ]', [])
        testCase('04', ' <>', '[ ]<SLOT/>', [CHILD_NODE, 1])
        testCase('05', ' <a', '[ ]', [])
        testCase('06', ' <a ', '[ ]', [])
        testCase('07', ' <svg ', '[ ]', [])
        testCase('08', ' <a>', '[ ]<A/>', [CHILD_NODE, 1])
        testCase('09', ' <svg>', '[ ]<svg/>', [CHILD_NODE, 1])
        testCase('10', '<a>', '<A/>', [CHILD_NODE, 0])
        testCase('11', '<SVG>', '<svg/>', [CHILD_NODE, 0])
        testCase('12', '<p>hello</p>', '<P>[hello]</P>', [])
        testCase('13', '</>', '', [])
        testCase('14', '< />', '[< />]', [])
        testCase('15', '<a/>', '<A/>', [])
        testCase('16', '<a />', '<A/>', [])
        testCase('17', '<a / >', '<A/>', [CHILD_NODE, 0])
        testCase('18', '<a //>', '<A/>', [])
        testCase('19', '<a u>', '<A [u]=[]/>', [CHILD_NODE, 0])
        testCase('20', '<a =u>', Error`Failed to execute 'setAttribute' on 'Element': '=u' is not a valid attribute name.`, [])
        testCase('21', '<a u/>', '<A [u]=[]/>', [])
        testCase('22', '<a u=1>', '<A [u]=[1]/>', [CHILD_NODE, 0])
        testCase('23', '<a u="2">', '<A [u]=[2]/>', [CHILD_NODE, 0])
        testCase('24', `<a u='3'>`, '<A [u]=[3]/>', [CHILD_NODE, 0])
        testCase('25', `<a "b c"=d>`, Error`Failed to execute 'setAttribute' on 'Element': '"b' is not a valid attribute name.`, [])
        testCase('26', `<a u='3' f="g"/>`, '<A [u]=[3] [f]=[g]/>', [])
        testCase('27', `<img>`, '<IMG/>', [])
        testCase('28', `  pre  <p><img></p>  post  `, '[  pre  ]<P><IMG/></P>[  post  ]', [])
        testCase('29', `<!>`, '{}', [])
        testCase('30', `<!->`, '{-}', [])
        testCase('31', `<!-->`, '{}', [])
        testCase('32', `<!--->`, '{}', [])
        testCase('33', `<!---->`, '{}', [])
        testCase('34', `<!-->-->`, '{}[-->]', [])
        testCase('35', `<!-- > -->`, '{ > }', [])
        testCase('36', `<!-- -> -->`, '{ -> }', [])
        testCase('37', `<!-- --> -->`, '{ }[ -->]', [])
        testCase('38', ` <!--no comment--> `, '[ ]{no comment}[ ]', [])
        testCase('39', `${HOLE}`, '{}', [HOOK_NODE, 0])
        testCase('40', `x${HOLE}y`, '[x]{}[y]', [HOOK_NODE, 1])
        testCase('41', `<${HOLE}>`, '<SLOT/>', [HOOK_NODE, 0, CHILD_NODE, 0])
        testCase('42', `<p${HOLE}>`, '<P/>', [CHILD_NODE, 0, HOOK_ATTR])
        testCase('43', `<p ${HOLE} ${HOLE}>`, '<P/>', [CHILD_NODE, 0, HOOK_ATTR, HOOK_ATTR])
        testCase('44', `<p${HOLE} />`, '<P/>', [CHILD_NODE, 0, HOOK_ATTR, PARENT_NODE])
        testCase('45', `<a />xyz<p${HOLE}a>`, '<A/>[xyz]<P [a]=[]/>', [CHILD_NODE, 2, HOOK_ATTR])
        testCase('46', `<${HOLE} a=b>`, '<SLOT [a]=[b]/>', [HOOK_NODE, 0, CHILD_NODE, 0])
        testCase('47', `<b ${HOLE}=${HOLE}>`, Error`Failed to execute 'setAttribute' on 'Element': '=' is not a valid attribute name.`, [])
        testCase('48', `<b a=${HOLE}>`, '<B/>', [CHILD_NODE, 0, HOOK_VALUE, 'a'])
        testCase('49', `<b a=b${HOLE}>`, '<B [a]=[b]/>', [CHILD_NODE, 0, HOOK_ATTR])
        testCase('50', `<b a=b${HOLE}c d>`, '<B [a]=[b] [c]=[] [d]=[]/>', [CHILD_NODE, 0, HOOK_ATTR])
        testCase('51', `<b a='b${HOLE}c'>`, '<B [a]=[b\x01c]/>', [CHILD_NODE, 0, HOOK_QUOTE, 'a'])
        testCase('52', `<!-- ${HOLE} -->`, '{ \x01 }', [HOOK_COMMENT, 0])
        testCase('53', `<a><b>x</b></a>`, '<A><B>[x]</B></A>', [])
        testCase('54', `<a><b>x${HOLE}</b></a>`, '<A><B>[x]{}</B></A>', [CHILD_NODE, 0, CHILD_NODE, 0, HOOK_NODE, 1, PARENT_NODE, PARENT_NODE])
    })

    mocha.run()

</script>
</body>
</html>
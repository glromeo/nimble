<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>parseHtml spec</title>
</head>
<body>
<div id="root"></div>
<script src="../../node_modules/chai/chai.js"></script>
<script src="../../node_modules/mocha/mocha.js"></script>
<script type="module">
    import {
        parseHtml,
        HOLE,
        APPEND_TEXT,
        APPEND_COMMENT,
        APPEND_CHILD,
        BOOL_ATTR,
        SET_ATTR,
        PARENT_NODE,
        HOOK_NODE,
        HOOK_ELEMENT,
        HOOK_COMMENT,
        HOOK_ATTR,
        HOOK_VALUE,
        HOOK_QUOTE
    } from './parseHtml.alt.mjs'
    import {WebConsole} from '../test/web-console.mjs'

    mocha.setup('tdd')
    mocha.checkLeaks()
    mocha.reporter(WebConsole)

    const {expect} = chai

    function snapshot(root) {
        let text = ''
        for (const node of root.childNodes) {
            if (node.tagName) {
                text += `<${node.tagName}`
                if (node.attributes) for (const {name, value} of node.attributes) {
                    text += ` [${name}]=[${value}]`
                }
                if (node.childNodes.length) {
                    text += '>'
                    text += snapshot(node)
                    text += `</${node.tagName}>`
                } else {
                    text += '/>'
                }
            } else if (node.nodeType === 8) {
                text += `{${node.data}}`
            } else {
                text += `[${node.data}]`
            }
        }
        return text
    }

    function dom(strings) {
        const text = strings.join(HOLE)
        const hasChild = text.endsWith(' \x01')
        switch (text[0]) {
            case '#':
                let data = text.slice(1)
                if (hasChild) {
                    data += arguments[arguments.length - 1]
                }
                return document.createTextNode(data)
            case '@':
                const fragment = document.createDocumentFragment()
                for (let i = 1; i < arguments.length; i++) {
                    fragment.appendChild(arguments[i])
                }
                return fragment
            default:
                const parts = (hasChild ? text.slice(0, -2) : text).split(' ')
                const el = document.createElement(parts[0])
                for (let i = 1, argIndex = 0; i < parts.length; i++) {
                    const [attrName, attrValue] = parts[i].split('=')
                    el.setAttribute(attrName, attrValue === HOLE ? arguments[++argIndex] : attrValue)
                }
                if (hasChild) {
                    const child = arguments[arguments.length - 1]
                    if (typeof child === 'string') {
                        el.innerHTML = child
                    } else {
                        el.appendChild(child)
                    }
                }
                return el
        }
    }

    suite('text nodes', () => {

        const testCase = (id, input, commands, args) => {
            test(`#${id}: '${input}'`, () => {
                try {
                    expect(JSON.stringify(parseHtml(input))).to.eq(JSON.stringify([commands, args]))
                } catch (error) {
                    if (commands instanceof Error) {
                        expect(error.message).to.eq(commands.message)
                    } else {
                        throw error
                    }
                }
            })
        }

        const SAME = null

        testCase('00', '', [], [])
        testCase('01', ' ', [APPEND_TEXT], [' '])
        testCase('02', ' <', [APPEND_TEXT], [' <'])
        testCase('03', ' < ', [APPEND_TEXT], [' < '])
        testCase('04', ' <>', [APPEND_TEXT, APPEND_CHILD], [' ', 'slot'])
        testCase('05', ' <a', [APPEND_TEXT], [' '])
        testCase('06', ' <a ', [APPEND_TEXT], [' '])
        testCase('07', ' <a b', [APPEND_TEXT], [' '])
        testCase('e7', ' <a a ', [APPEND_TEXT], [' ', 'a']) // It doesn't really matter
        testCase('08', ' <a b=', [APPEND_TEXT], [' '])
        testCase('09', ' <a b=c', [APPEND_TEXT], [' '])
        testCase('10', ' <a b=c ', [APPEND_TEXT], [' '])
        testCase('11', '<p><a b=c /', [APPEND_CHILD], ['p'])
        testCase('12', ' <a b="c"', [APPEND_TEXT], [' '])
        testCase('13', ' <svg ', [APPEND_TEXT], [' '])
        testCase('14', ' <a>', [APPEND_TEXT, APPEND_CHILD], [' ', 'a'])
        testCase('15', ' <svg>', [APPEND_TEXT, APPEND_CHILD], [' ', 'svg'])
        testCase('16', '<A>', [APPEND_CHILD], ['a'])
        testCase('17', '<SVG>', [APPEND_CHILD], ['svg'])
        testCase('18', '<p>hello</p>', [APPEND_CHILD, APPEND_TEXT, PARENT_NODE], ['p', 'hello'])
        testCase('19', '</>', [PARENT_NODE], [])
        testCase('20', '< />', [APPEND_TEXT], ['< />'])
        testCase('21', '<a/>', [APPEND_CHILD, PARENT_NODE], ['a'])
        testCase('22', '<a />', [APPEND_CHILD, PARENT_NODE], ['a'])
        testCase('23', '<a / >', [APPEND_CHILD], ['a'])
        testCase('24', '<a //>', [APPEND_CHILD, PARENT_NODE], ['a'])
        testCase('25', '<a u>', [APPEND_CHILD, BOOL_ATTR], ['a', 'u'])
        testCase('29', '<a =u>', [APPEND_CHILD, BOOL_ATTR], ['a', '=u']) // This will fail later on...
        testCase('30', '<a u/>', [APPEND_CHILD, BOOL_ATTR, PARENT_NODE], ['a', 'u'])
        testCase('31', '<a u=/>', [APPEND_CHILD, SET_ATTR, PARENT_NODE], ['a', 'u', ''])
        testCase('35', '<a u=1>', [APPEND_CHILD, SET_ATTR], ['a', 'u', '1'])
        testCase('36', '<a u=1/>', [APPEND_CHILD, SET_ATTR, PARENT_NODE], ['a', 'u', '1'])
        testCase('37', '<a U=1 >', [APPEND_CHILD, SET_ATTR], ['a', 'U', '1'])
        testCase('38', '<a u="2">', [APPEND_CHILD, SET_ATTR], ['a', 'u', '2'])
        testCase('39', `<a u='3'>`, [APPEND_CHILD, SET_ATTR], ['a', 'u', '3'])
        testCase('40', `<a "b c"=d>`, [APPEND_CHILD, BOOL_ATTR, SET_ATTR], ['a', '"b', 'c"', 'd'])
        testCase('41', `<a u='3' f="g"/>`, [APPEND_CHILD, SET_ATTR, SET_ATTR, PARENT_NODE], ['a', 'u', '3', 'f', 'g'])
        testCase('42', `<img>`, [APPEND_CHILD, PARENT_NODE], ['img'])
        testCase('27', '<img src>',  [APPEND_CHILD, BOOL_ATTR, PARENT_NODE], ['img', 'src'])
        testCase('28', '<img src >',  [APPEND_CHILD, BOOL_ATTR, PARENT_NODE], ['img', 'src'])
        testCase('33', '<img src/>', [APPEND_CHILD, BOOL_ATTR, PARENT_NODE], ['img', 'src'])
        testCase('34', '<img src />', [APPEND_CHILD, BOOL_ATTR, PARENT_NODE], ['img', 'src'])
        testCase('26', '<img class="image" >', [APPEND_CHILD, SET_ATTR, PARENT_NODE], ['img', 'class', 'image'])
        testCase('32', '<img class="image" />', [APPEND_CHILD, SET_ATTR, PARENT_NODE], ['img', 'class', 'image'])
        testCase('43', `  pre  <p><img></p>  post  `, [APPEND_TEXT, APPEND_CHILD, APPEND_CHILD, PARENT_NODE, PARENT_NODE, APPEND_TEXT], ['  pre  ', 'p', 'img', '  post  '])
        testCase('44', `<!>`, [APPEND_COMMENT], [''])
        testCase('45', `<!->`, [APPEND_COMMENT], ['-'])
        testCase('46', `<!-->`, [APPEND_COMMENT], [''])
        testCase('47', `<!--->`, [APPEND_COMMENT], [''])
        testCase('48', `<!---->`, [APPEND_COMMENT], [''])
        testCase('49', `<!-->-->`, [APPEND_COMMENT, APPEND_TEXT], ['','-->'])
        testCase('50', `<!-- > -->`, [APPEND_COMMENT], [' > '])
        testCase('51', `<!-- -> -->`, [APPEND_COMMENT], [' -> '])
        testCase('52', `<!-- --> -->`, [APPEND_COMMENT, APPEND_TEXT], [' ',' -->'])
        testCase('53', ` <!--no comment--> `, [APPEND_TEXT, APPEND_COMMENT, APPEND_TEXT], [' ', 'no comment', ' '])
        testCase('54', `${HOLE}`, [HOOK_NODE], [])
        testCase('55', `x${HOLE}y`, [APPEND_TEXT, HOOK_NODE, APPEND_TEXT], ['x', 'y'])
        testCase('56', `<${HOLE}>`, [HOOK_ELEMENT], [])
        testCase('57', `<p${HOLE}>`, [APPEND_CHILD, HOOK_ATTR], ['p'])
        testCase('58', `<p a${HOLE}>`, [APPEND_CHILD, BOOL_ATTR, HOOK_ATTR], ['p', 'a'])
        testCase('59', `<p ${HOLE} ${HOLE}>`, [APPEND_CHILD, HOOK_ATTR, HOOK_ATTR], ['p'])
        testCase('60', `<p${HOLE} />`, [APPEND_CHILD, HOOK_ATTR, PARENT_NODE], ['p'])
        testCase('61', `<a />xyz<p${HOLE}a>`, [APPEND_CHILD, PARENT_NODE, APPEND_TEXT, APPEND_CHILD, HOOK_ATTR, BOOL_ATTR], ['a', 'xyz', 'p', 'a'])
        testCase('62', `<${HOLE} a=b>`, [HOOK_ELEMENT, SET_ATTR], ['a', 'b'])
        testCase('63', `<b ${HOLE}=${HOLE}>`, [APPEND_CHILD, HOOK_ATTR, BOOL_ATTR, HOOK_ATTR], ['b', '='])
        testCase('64', `<b a=${HOLE}>`, [APPEND_CHILD, HOOK_VALUE], ['b', 'a'])
        testCase('65', `<b a='${HOLE}'>`, [APPEND_CHILD, HOOK_VALUE], ['b', 'a'])
        testCase('66', `<b a="${HOLE}">`, [APPEND_CHILD, HOOK_VALUE], ['b', 'a'])
        testCase('67', `<b a=b${HOLE}>`, [APPEND_CHILD, SET_ATTR, HOOK_ATTR], ['b', 'a', 'b'])
        testCase('68', `<b a=b${HOLE}c d>`, [APPEND_CHILD, SET_ATTR, HOOK_ATTR, BOOL_ATTR, BOOL_ATTR], ['b', 'a', 'b', 'c', 'd'])
        testCase('69', `<b a='b${HOLE}c'>`, [APPEND_CHILD, HOOK_QUOTE], ['b', 'a', 'b\x01c'])
        testCase('70', `<!-- ${HOLE} -->`, [APPEND_COMMENT, HOOK_COMMENT], [' \x01 '])
        testCase('71', `<a><b>x</b></a>`, [APPEND_CHILD, APPEND_CHILD,APPEND_TEXT,PARENT_NODE,PARENT_NODE], ['a', 'b', 'x'])
        testCase('72', `<a><b>x${HOLE}</b></a>`, [APPEND_CHILD, APPEND_CHILD,APPEND_TEXT,HOOK_NODE, PARENT_NODE,PARENT_NODE], ['a', 'b', 'x'])
    })

    mocha.run()

</script>
</body>
</html>